<!DOCTYPE html>
<html>

<head>
  <title>Nostr Workshop FOSSCOMM 2023</title>
  <link rel="icon" type="image/x-icon" href="/images/favicon.ico">
  <script src="https://cdn.tailwindcss.com"></script>
  <script> tailwind.config = { corePlugins: { preflight: false } } </script>
  <script type="module">
    import { html, render, useEffect, useState } from 'https://esm.sh/htm/preact/standalone'
    import * as nostrTools from 'https://esm.sh/nostr-tools'

    // Generate a private key and a public key
    let privateKey = localStorage.getItem("privateKey") || nostrTools.generatePrivateKey() // hex string
    let publicKey = nostrTools.getPublicKey(privateKey) // hex string
    localStorage.setItem("privateKey", privateKey);
    console.log("your private key:", privateKey)

    // Connect to a relay
    const relay = nostrTools.relayInit('wss://nos.lol')
    relay.on('connect', () => {
      console.log(`connected to ${relay.url}`)
    })
    relay.on('error', () => {
      console.log(`failed to connect to ${relay.url}`)
    })
    await relay.connect()

    // get your profile data 
    const profileEvent = await relay.get({
      kinds: [0],
      authors: [publicKey]
    })
    const profile = profileEvent && JSON.parse(profileEvent.content)

    function App() {
      const [events, setEvents] = useState([]);

      useEffect(() => {
        // subscribe to yourself 
        let sub = relay.sub([
          {
            kinds: [1],
            '#t': ['fosscommT']
          },
        ])

        sub.on('event', async event => {
          console.log('got event:', event)
          // check if there are metadata for author
          let profileEvent = await relay.get({
            kinds: [0],
            authors: [event.pubkey]
          })
          if (profileEvent) {
            const authorProfile = JSON.parse(profileEvent.content)
            event.author = authorProfile
          }
          setEvents(prev => [event, ...prev])
        })

      }, [])

      const publishMessage = async () => {
        let event = {
          kind: 1,
          created_at: Math.floor(Date.now() / 1000),
          tags: [['t', 'fosscommT']],
          content: document.getElementById("message").value,
          pubkey: publicKey,
        }
        // Sign event
        event.id = nostrTools.getEventHash(event)
        event.sig = nostrTools.getSignature(event, privateKey)
        await relay.publish(event)
      }

      return html`
      <div class="flex flex-col px-12 lg:px-64">
        <h1>Welcome to Nostr workshop!</h1>
        <h3>Hello</h3>
        <div class="flex items-center pb-4">
          ${profile ? html`
            <img class="rounded-full w-14 " src=${profile.picture}/>
            <div class="flex flex-col px-2">
              <span> ${profile.name} </span>
            </div>
            ` : html` <span> ${publicKey} </span> 
          `}
        </div>
        <textarea id="message" placeholder="write your message" />
        <button onClick=${() => publishMessage()}>Submit message</button>

        <h2> Messages </h2>
        <div class="flex flex-col">
          ${events.sort((a, b) => b.created_at - a.created_at).map((event) => html`
            <div class="flex flex-col p-3 m-2 border-2 border-solid">
              <div class="flex items-center">
                <img class="rounded-full border-1 border-solid w-6 h-6" src=${event.author?.picture || ""}/>
                <span class="text-sm px-2"> ${event.author?.name || event.pubkey}</span>
              </div>
              <span class="py-4 font-bold">${event.content}</span>
              <span class="text-sm self-end"> at ${new Date(event.created_at * 1000).toLocaleTimeString()} (${new Date(event.created_at * 1000).toLocaleDateString()}) </span>
            </div>
          `)}
        </div>
      </div> `;
    }
    render(html`<${App} />`, document.body);
  </script>

</head>

</html>